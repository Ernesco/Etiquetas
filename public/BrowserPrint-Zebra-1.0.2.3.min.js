var BrowserPrint = function() {
    var e = {};
    // Función para detectar la impresora predeterminada
    e.getDefaultDevice = function(type, success, error) {
        var url = "https://localhost:9101/default?type=" + type;
        var xhr = new XMLHttpRequest;
        xhr.open("GET", url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var res = JSON.parse(xhr.responseText);
                // ESTA ES LA MAGIA: Convertimos el resultado en un objeto con funciones
                success(new BrowserPrint.Device(res));
            } else if (xhr.readyState == 4) {
                error(xhr.responseText);
            }
        };
        xhr.send();
    };
    return e;
}();

// Definimos qué puede hacer una "Device" (incluyendo el bendito .send)
BrowserPrint.Device = function(data) {
    this.name = data.name;
    this.uid = data.uid;
    this.connection = data.connection;
    this.deviceType = data.deviceType;
    this.version = data.version;
    this.provider = data.provider;
    this.manufacturer = data.manufacturer;

    this.send = function(dataToSend, finishedCallback, errorCallback) {
        var url = "https://localhost:9101/write";
        var xhr = new XMLHttpRequest;
        xhr.open("POST", url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) finishedCallback(xhr.responseText);
            else if (xhr.readyState == 4) errorCallback(xhr.responseText);
        };
        var msg = {
            device: { name: this.name, uid: this.uid, connection: this.connection, deviceType: this.deviceType, version: this.version, provider: this.provider, manufacturer: this.manufacturer },
            data: dataToSend
        };
        xhr.send(JSON.stringify(msg));
    };
};